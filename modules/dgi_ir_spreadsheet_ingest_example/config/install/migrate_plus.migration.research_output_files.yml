id: research_output_files
label: Create files from rows in the csv.
migration_group: research_output
source:
  constants:
    DRUPAL_FILE_DIRECTORY: 'public://research_output_migration/'
    SOURCE_BINARY_DIRECTORY: '/opt/www/drupal/modules/contrib/dgi_ir/modules/dgi_ir_spreadsheet_ingest_example/fixtures/'
  columns:
    - 'id'
    - 'digital_file'
    - 'mimetype'
process:
  field_digital_file_exists:
    plugin: skip_on_empty
    method: row
    source: digital_file
    message: 'No file provided in digital_file for this row'
  destination_filename:
    - plugin: callback
      callable: basename
      source: digital_file
  destination_full_path:
    - plugin: concat
      source:
        - constants/DRUPAL_FILE_DIRECTORY
        - '@destination_filename'
    - plugin: urlencode
    - plugin: dgi_migrate.process.log
      template: 'Destination Full Path: :value'
      level: 4
  source_path:
    - plugin: concat
      source:
        - constants/SOURCE_BINARY_DIRECTORY
        - digital_file
  uri:
    - plugin: file_copy
      source:
        - '@source_path'
        - '@destination_full_path'
      file_exists: 'rename'
      move: TRUE
  filemime: mimetype
  filename: '@destination_filename'
  status:
    - plugin: default_value
      default_value: 1
  filesize:
    - plugin: callback
      source: '@uri'
      callable: filesize
destination:
  plugin: 'entity:file'
  validate: true
dependencies:
  enforced:
    module:
      - dgi_ir_spreadsheet_ingest_example
