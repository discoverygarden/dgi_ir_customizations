id: research_output_media
label: Create media from rows in the csv.
migration_group: research_output
source:
  columns:
    - 'id'
    - 'title'
    - 'digital_file'
process:
  field_digital_file_exists:
    - plugin: skip_on_empty
      method: row
      source: 'digital_file'
      message: 'No entry in this row for digital_file'

  name: title

  _file_id:
    - plugin: migration_lookup
      migration: research_output_files
      source: id
      no_stub: true
  _file:
    plugin: dgi_migrate.load_entity
    source: '@_file_id'
    entity_type: entity:file
  # XXX: Somewhat counter-intuitive, but it will just ignore those file field
  # entries with which the target bundle does not deal.
  field_media_audio_file: '@_file'
  field_media_file: '@_file'
  field_media_image/target_id: '@_file_id'
  field_media_image/alt: '@name'
  field_media_video_file: '@_file'

  field_media_use:
    - plugin: default_value
      default_value: http://pcdm.org/use#ResearchOutput
    - plugin: entity_lookup
      bundle_key: vid
      bundle: islandora_media_use
      value_key: field_external_uri
      entity_type: taxonomy_term
      # XXX: migrate_plus's case comparison makes assumptions about the entity's
      # "main" property... we want "uri", but it assumes "value".
      ignore_case: true

  bundle:
    - plugin: explode
      delimiter: '.'
      source: digital_file
    - plugin: array_pop
    - plugin: static_map
      default_value: 'file'
      map:
        'mp3': 'audio'
        'wav': 'audio'
        'aac': 'audio'
        'txt': 'document'
        'rtf': 'document'
        'doc': 'document'
        'docx': 'document'
        'ppt': 'document'
        'pptx': 'document'
        'xls': 'document'
        'xlsx': 'document'
        'pdf': 'document'
        'odf': 'document'
        'odg': 'document'
        'odp': 'document'
        'ods': 'document'
        'odt': 'document'
        'fodt': 'document'
        'fods': 'document'
        'fodp': 'document'
        'fodg': 'document'
        'key': 'document'
        'numbers': 'document'
        'pages': 'document'
        'png': 'image'
        'gif': 'image'
        'jpg': 'image'
        'jpeg': 'image'
        'tif': 'image'
        'tiff': 'image'
        'jp2': 'image'
        'mp4': 'video'

  field_media_of/target_id:
    - plugin: migration_lookup
      migration: research_output_nodes
      source: 'id'
      no_stub: true

destination:
  plugin: entity:media
  default_bundle: file
migration_dependencies:
  required:
    - research_output_files
    - research_output_nodes
dependencies:
  enforced:
    module:
      - dgi_ir_spreadsheet_ingest_example
